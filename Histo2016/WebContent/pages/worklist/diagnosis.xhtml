<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:include src="common/navigationBar.xhtml"></ui:include>

	<c:set var="selectedTask"
		value="#{worklistHandlerAction.selectedPatient.selectedTask}" />

	<p:panel style="width:100%;" id="diagnosisView"
		styleClass=" collapsedBorders noPadding noBorders">

		<h:panelGrid columns="1" styleClass="noPadding">
			<h:outputLabel value="#{msg['body.diagnosis.headline']}"
				style="font-size:1.5em;"></h:outputLabel>

			<h:panelGrid columns="2" style="margin-top:20px"
				styleClass="noPaddingAll noBordersAll collapsedBordersAll"
				columnClasses="verticalAlignTop,verticalAlignTop">

				<h:panelGrid columns="1" style="width:410px"
					styleClass="noPaddingAll noBordersAll collapsedBordersAll">
					<!-- TODO Update background object, e.g. .blure() (inputtext) -->
					<!-- material -->
					<c:forEach items="#{selectedTask.samples}" var="sample"
						varStatus="loopCount">
						<h:panelGrid columns="3" id="materialTable"
							columnClasses="firstColumn, secondColumn, thirdColumn"
							styleClass="materialTable noPaddingAll noBordersAll collapsedBordersAll">

							<h:panelGroup>
								<h:outputLabel value="#{msg['body.diagnosis.material']}"
									style="font-size:1.2em" rendered="#{loopCount.index eq 0}"></h:outputLabel>
							</h:panelGroup>

							<h:outputLabel value="#{sample.sampleID}" />

							<p:selectOneMenu value="#{sample.material}"
								disabled="#{selectedTask.diagnosisCompleted}"
								styleClass="smallInput" editable="true"
								style="width:200px;float:right;margin-right:30px;">
								<f:selectItem
									itemLabel="#{msg['body.receiptlog.material.select']}"
									itemValue="none" />
								<f:selectItems
									value="#{taskHandlerAction.allAvailableMaterials}" var="list"
									itemLabel="#{list.name}" itemValue="#{list.name}" />

								<p:ajax event="change" execute="@this"
									listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.sample.material',selectedTask.taskID,sample.material.name)}" />
							</p:selectOneMenu>
						</h:panelGrid>
					</c:forEach>

					<h:panelGroup layout="block"
						style="font-size:1.0em;margin-top:10px;">
						<h:outputLabel value="#{msg['body.diagnosis.story']}"></h:outputLabel>
					</h:panelGroup>

					<h:graphicImage value="/resources/gfx/augen.png"
						style="width: 280px;float:right;margin-right:30px;" />

					<!-- eye -->
					<h:panelGrid columns="2" columnClasses="verticalAlignTop,"
						style="width:100%"
						styleClass="noPaddingAll noBordersAll collapsedBordersAll">
						<p:selectOneMenu styleClass="smallInput"
							disabled="#{selectedTask.diagnosisCompleted}"
							value="#{selectedTask.eye}">

							<f:selectItems value="#{enumProvider.eyes}" var="eye"
								itemLabel="#{msg['enum.eye.'.concat(eye)]}" itemValue="#{eye}" />

							<p:ajax event="change" execute="@this"
								listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.eye',msg['enum.eye.'.concat(selectedTask.eye)])}" />
						</p:selectOneMenu>

						<p:inputTextarea rows="2" id="stroyField"
							disabled="#{selectedTask.diagnosisCompleted}"
							style="width: 270px;float:right;margin-right:30px;"
							value="#{selectedTask.caseHistory}">
							<p:ajax event="change" execute="@this"
								listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.caseHistory',selectedTask.caseHistory)}" />
							<p:watermark value="#{msg['body.diagnosis.story.watermark']}"
								for="stroyField" />
						</p:inputTextarea>
					</h:panelGrid>
				</h:panelGrid>


				<h:panelGrid columns="2"
					styleClass="noPaddingAll noBordersAll collapsedBordersAll">
					<!-- date of surgery -->
					<h:outputLabel value="#{msg['body.diagnosis.surgeryDate']}" />
					<p:calendar pattern="dd.MM.yyyy" mask="true"
						disabled="#{selectedTask.diagnosisCompleted}"
						value="#{selectedTask.dateOfSugeryAsDate}">
						<p:ajax event="dateSelect"
							listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
						<f:ajax event="change" execute="@this"
							listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
					</p:calendar>

					<!-- date of receipt -->
					<h:outputLabel value="#{msg['body.diagnosis.taskEDate']}" />
					<p:calendar pattern="dd.MM.yyyy" mask="true"
						disabled="#{selectedTask.diagnosisCompleted}"
						value="#{selectedTask.dateOfReceiptAsDate}">
						<p:ajax event="dateSelect"
							listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.receiptDate',mainHandlerAction.date(selectedTask.dateOfReceiptAsDate))}" />
						<f:ajax event="change" execute="@this"
							listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.receiptDate',mainHandlerAction.date(selectedTask.dateOfReceiptAsDate))}" />
					</p:calendar>

					<!-- Task Number -->
					<h:outputLabel value="#{msg['body.diagnosis.taskNumber']}" />
					<p:inputText disabled="true" value="#{selectedTask.taskID}" />

					<!-- insurance -->
					<h:outputLabel value="#{msg['body.diagnosis.insurance']}" />

					<p:selectOneButton disabled="#{selectedTask.diagnosisCompleted}"
						value="#{worklistHandlerAction.selectedPatient.privateInsurance}">
						<f:selectItem itemLabel="regulär" itemValue="#{false}]" />
						<f:selectItem itemLabel="privat" itemValue="#{true}" />
					</p:selectOneButton>

					<!-- ward -->
					<h:outputLabel value="#{msg['body.diagnosis.ward']}" />

					<p:selectOneMenu id="wards" value="#{selectedTask.ward}"
						effect="fold" editable="true"
						disabled="#{selectedTask.diagnosisCompleted}">
						<f:selectItems value="#{taskHandlerAction.selectableWards}" />
						<p:ajax event="change" execute="@this"
							listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.ward',selectedTask.ward)}" />
					</p:selectOneMenu>

					<!-- surgeon -->
					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="#{msg['body.diagnosis.surgeon']}" />
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel style="margin-left:10px;"
							value="#{selectedTask.getPrimaryContact('SURGEON')}"></h:outputLabel>

						<p:commandLink title="#{msg['body.receiptlog.notification.hint']}"
							rendered="#{!selectedTask.diagnosisCompleted}"
							style="float: right; margin-right:5px;"
							actionListener="#{contactHandlerAction.showContacts(selectedTask)}">
							<i class="fa fa-fw fa-cog" />
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel value="#{msg['body.diagnosis.privatePhysician']}"></h:outputLabel>
					</h:panelGroup>

					<h:panelGroup layout="block" style="margin: 6px 0px 3px 0px;">
						<h:outputLabel style="margin-left:10px;"
							value="#{selectedTask.getPrimaryContact('PRIVATE_PHYSICIAN')}"></h:outputLabel>

						<p:commandLink title="#{msg['body.receiptlog.notification.hint']}"
							style="float: right; margin-right:5px;"
							rendered="#{!selectedTask.diagnosisCompleted}"
							actionListener="#{contactHandlerAction.showContacts(selectedTask)}">
							<i class="fa fa-fw fa-cog" />
							<p:ajax event="dialogReturn" update="navigationForm contentForm" />
						</p:commandLink>
					</h:panelGroup>
				</h:panelGrid>
			</h:panelGrid>

			<p:separator />

			<h:outputLabel value="#{msg['body.diagnosis.histologicalRecord']}"></h:outputLabel>
			<h:panelGroup id="extendedTextParent">
				<p:editor id="extendedText" widgetVar="extendedText"
					disabled="#{selectedTask.diagnosisCompleted}"
					value="#{selectedTask.report.histologicalRecord}"
					style="width:100%"
					valueChangeListener="#{helperHandlerAction.valueChanged}">
				</p:editor>
				<p:commandButton style="display:none" id="submitDiagnosisChange"
					name="submitDiagnosisChange" process="extendedTextParent"></p:commandButton>

				<f:verbatim>
					<script type="text/javascript">
						$(document)
								.ready(
										function() {
											var first = true;
											//documentation is the editor widgetVar
											PF('extendedText').jq
													.find("iframe")
													.contents()
													.find('body')
													.blur(
															function() {
																if (first) {
																	first = false;
																	return;
																}
																$(
																		'#contentForm\\:submitDiagnosisChange')
																		.click();
															});
										});
					</script>
				</f:verbatim>
			</h:panelGroup>

			<h:outputLabel value="#{msg['body.diagnosis.diagnosis']}"></h:outputLabel>

			<ui:repeat var="sampel" value="#{selectedTask.samples}">

				<c:set var="diagnosis" value="#{sampel.getLastRelevantDiagnosis()}" />

				<!-- Diagnosis -->
				<p:panelGrid id="diagnosisTable"
					styleClass="diagnosisTable noPaddingAll noBordersAll collapsedBordersAll"
					columnClasses="firstColumn,secondColumn,thirdColumn,fourthColumn">

					<p:row>
						<p:column style=" width:100px;">
							<h:outputLabel
								value="#{msg['body.diagnosis.diagnosis.sample']} #{sampel.sampleID}"></h:outputLabel>
						</p:column>
						<p:column>
							<h:panelGrid columns="2"
								styleClass="noPaddingAll noBordersAll collapsedBordersAll">
								<!-- Diagnosis select -->
								<p:selectOneMenu value="#{diagnosis.diagnosisPrototype}"
									disabled="#{diagnosis.finalized}"
									styleClass="customSerachSelectMenu"
									panelStyleClass="customSerachSelectMenuPanel"
									converter="#{settingsHandlerAction.diagnosisPrototypeListTransformer}"
									filter="true" filterMatchMode="startsWith">
									<f:selectItem
										itemLabel="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.choose']}"
										itemValue="#{null}" />

									<f:selectItems
										value="#{settingsHandlerAction.allAvailableDiagnosisPrototypes}"
										var="diagnosisPrototype"
										itemLabel="#{diagnosisPrototype.name}"
										itemValue="#{diagnosisPrototype}" />

									<p:ajax event="change"
										listener="#{diagnosis.updateDiagnosisWithPrest(diagnosis.diagnosisPrototype)}" />
									<p:ajax event="change"
										update="diagnosisTable :contentForm:extendedText"
										listener="#{diagnosisHandlerAction.onDiagnosisPrototypeChanged(diagnosis)}" />
								</p:selectOneMenu>
								<!-- copy diagnosis text -->
								<p:commandLink styleClass="noUnderlineAtLink"
									style="margin-left:20px;"
									title="#{msg['body.diagnosis.diagnosis.histologicalRecordPreset']}"
									rendered="#{diagnosis.diagnosisPrototype ne null}"
									actionListener="#{diagnosisHandlerAction.prepareCopyHistologicalRecord(diagnosis)}"
									update=":contentForm:extendedText">
									<i class="fa fa-hand-o-up"></i>
									<p:ajax event="dialogReturn"
										update="navigationForm contentForm" />
								</p:commandLink>
							</h:panelGrid>
						</p:column>
						<p:column>
							<!-- malign -->
							<h:panelGrid columns="2" style="float:right;margin-right:20px;"
								styleClass="verticalAlignMiddleAll">
								<h:outputLabel
									value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.malign']}" />
								<p:selectBooleanCheckbox value="#{diagnosis.malign}"
									style="margin:3px 0px 0px 3px;"
									disabled="#{diagnosis.finalized}">

									<f:ajax event="change" execute="@this"
										listener="#{diagnosisHandlerAction.diagnosisDataChanged(diagnosis,'log.patient.task.sample.diagnosis.changed.malign',diagnosis.malign)}" />
								</p:selectBooleanCheckbox>
							</h:panelGrid>
						</p:column>
					</p:row>
					<p:row>
						<p:column></p:column>
						<p:column colspan="2">
							<!-- diagnosis text -->
							<p:inputTextarea value="#{diagnosis.diagnosis}"
								id="diagnosisText" style="margin-top:5px;"
								disabled="#{diagnosis.finalized}" styleClass="diagnosisText"
								rows="1">
								<p:watermark for="diagnosisText"
									value="#{msg['body.receiptlog.tab.diangonsis.data.diangosis.watermark']}" />
								<f:ajax event="change" execute="@this"
									listener="#{diagnosisHandlerAction.diagnosisDataChanged(diagnosis,'log.patient.task.sample.diagnosis.changed.diagnosis.text',diagnosis.diagnosis)}" />
							</p:inputTextarea>

						</p:column>
					</p:row>
				</p:panelGrid>
				<!-- Diagnosis -->
			</ui:repeat>

			<p:panelGrid style="width:100%;margin-top:30px;"
				styleClass="noPaddingAll noBordersAll collapsedBordersAll">
				<p:row>
					<p:column style="width:30%">
						<h:outputLabel value="Datum Unterschrift"></h:outputLabel>
					</p:column>
					<p:column style="width:30%">

					</p:column>
					<p:column style="width:30%">
						<p:selectOneMenu disabled="#{selectedTask.diagnosisCompleted}"
							styleClass="customSerachSelectMenu" style="width:80% !important"
							panelStyleClass="customSerachSelectMenuPanel"
							value="#{taskHandlerAction.consultantToSign}"
							converter="#{taskHandlerAction.allAvailablePhysiciansTransformer}"
							filter="true" filterMatchMode="contains">
							<f:selectItem itemLabel="Oberarzt auswählen" itemValue="#{null}" />

							<f:selectItems
								value="#{taskHandlerAction.allAvailablePhysicians}"
								var="physician" itemLabel="#{physician.fullName}"
								itemValue="#{physician}" />

							<p:ajax event="change"
								oncomplete="$('#dialogContent\\:submitConsultantChange').click();" />

						</p:selectOneMenu>
					</p:column>
				</p:row>
				<p:row>
					<p:column>
						<p:calendar pattern="dd.MM.yyyy" mask="true"
							disabled="#{selectedTask.diagnosisCompleted}"
							value="#{selectedTask.dateOfSugeryAsDate}">
							<p:ajax event="dateSelect"
								listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
							<f:ajax event="change" execute="@this"
								listener="#{taskHandlerAction.taskDataChanged(selectedTask,'log.patient.task.dataChange.dateOfSurgery',mainHandlerAction.date(selectedTask.dateOfSugeryAsDate))}" />
						</p:calendar>
					</p:column>
					<p:column>
					</p:column>
					<p:column>
						<p:selectOneMenu styleClass="customSerachSelectMenu"
							id="consultantToSignRole" editable="true"
							style="width:80% !important"
							disabled="#{selectedTask.report.consultantToSign.physician eq null or diagnosis.finalized}"
							value="#{selectedTask.report.consultantToSign.role}">
							<f:selectItems value="#{enumProvider.signatureRoles}"
								var="signatureRole"
								itemLabel="#{msg['enum.signatureRole.'.concat(signatureRole)]}"
								itemValue="#{msg['enum.signatureRole.'.concat(signatureRole)]}" />
							<p:ajax event="change"
								oncomplete="$('#dialogContent\\:submitConsultantRoleChange').click();" />
						</p:selectOneMenu>
					</p:column>
				</p:row>
			</p:panelGrid>
		</h:panelGrid>
	</p:panel>
</ui:composition>

